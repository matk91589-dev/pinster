<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pingster</title>
    
    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/shop-cases.css">
    <link rel="stylesheet" href="css/animations.css">
    
    <style>
        /* Временные фиксы для Mini App */
        .phone-frame {
            height: 100vh;
            max-height: 100vh;
            border-radius: 0;
            padding-top: 0;
        }
        
        .content {
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .content::-webkit-scrollbar {
            display: none;
        }
        
        .screen {
            min-height: 100%;
            padding-bottom: 20px;
        }
        
        .main-screen .section-title {
            margin-top: 20px;
        }
        
        .mode-container {
            margin-top: 10px;
            gap: 12px;
        }
        
        .mode-btn {
            padding: 16px;
        }
        
        .bottom-nav {
            position: sticky;
            bottom: 0;
            background: #111317;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="content">
            <!-- ХЕДЕР (теперь виден всегда) -->
            <div class="header" id="mainHeader">
                <div class="logo" onclick="handleLogoClick()">
                    <span class="ping">Ping</span><span class="ster">ster</span>
                </div>
                <div id="settingsIcon" class="icon-settings" onclick="showSettingsScreen()">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.6 1.6 0 0 0 .3 1.8l.1.1-2 3.4-.1-.1a1.6 1.6 0 0 0-1.8-.3 1.6 1.6 0 0 0-1 1.5V22H9v-.6a1.6 1.6 0 0 0-1-1.5 1.6 1.6 0 0 0-1.8.3l-.1.1-2-3.4.1-.1a1.6 1.6 0 0 0 .3-1.8 1.6 1.6 0 0 0-1.5-1H2V9h.6a1.6 1.6 0 0 0 1.5-1 1.6 1.6 0 0 0-.3-1.8l-.1-.1 2-3.4.1.1a1.6 1.6 0 0 0 1.8.3H8a1.6 1.6 0 0 0 1-1.5V2h6v.6a1.6 1.6 0 0 0 1 1.5h.1a1.6 1.6 0 0 0 1.8-.3l.1-.1 2 3.4-.1.1a1.6 1.6 0 0 0-.3 1.8V9H22v4h-.6a1.6 1.6 0 0 0-1 1.5z"/>
                    </svg>
                </div>
            </div>

            <!-- СТАРТОВЫЙ ЭКРАН -->
            <div id="startScreen" class="screen start-screen">
                <div class="start-avatar-square" id="startAvatar">
                    <img src="pingster_logo.svg" alt="Pingster">
                </div>
                
                <div class="start-description-box">
                    <div class="start-description">
                        Pingster — площадка, где вы можете найти тиммейта за 30 секунд.<br>
                        Быстро, просто, без смс.<br>
                        Здесь можно находить друзей и просто тиммейта на одну катку.<br>
                        Фаниться или апать звания.
                    </div>
                </div>
                
                <button class="primary-btn" onclick="startApp()">Подключиться</button>
            </div>

            <!-- ГЛАВНЫЙ ЭКРАН -->
            <div id="mainScreen" class="screen screen-main main-screen" style="display: none;">
                <div class="section-title">Выбор режима</div>
                <div class="section-subtitle">Подберите подходящий</div>

                <div class="mode-container">
                    <button class="mode-btn faceit" onclick="showFaceitScreen()">FACEIT</button>
                    <button class="mode-btn premier" onclick="showPremierScreen()">PREMIER</button>
                    <button class="mode-btn prime" onclick="showPrimeScreen()">MM PRIME</button>
                    <button class="mode-btn public" onclick="showPublicScreen()">MM PUBLIC</button>
                </div>

                <div class="bottom-nav">
                    <div class="nav-item active" onclick="showMainScreen()">
                        <span class="nav-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M3 10L12 3l9 7v9a2 2 0 0 1-2 2h-4v-6H9v6H5a2 2 0 0 1-2-2z"/>
                            </svg>
                        </span>
                        <span class="nav-label">Главная</span>
                    </div>
                    <div class="nav-item" onclick="showShopScreen()">
                        <span class="nav-icon">
                            <svg viewBox="0 0 24 24">
                                <path d="M6 6h15l-1.5 9h-12z"/>
                                <circle cx="9" cy="21" r="1"/>
                                <circle cx="18" cy="21" r="1"/>
                            </svg>
                        </span>
                        <span class="nav-label">Магазин</span>
                    </div>
                    <div class="nav-item" onclick="showProfileScreen()">
                        <span class="nav-icon">
                            <svg viewBox="0 0 24 24">
                                <circle cx="12" cy="8" r="4"/>
                                <path d="M4 21c2-4 14-4 16 0"/>
                            </svg>
                        </span>
                        <span class="nav-label">Профиль</span>
                    </div>
                </div>
            </div>

            <!-- ОСТАЛЬНЫЕ ЭКРАНЫ (без изменений, но добавлены style="display: none;" к каждому) -->
            <div id="shopScreen" class="screen screen-shop" style="display: none;">
                <!-- ... содержимое shopScreen ... -->
                <div class="title-row">
                    <div class="title-left">
                        <div class="section-title">Магазин</div>
                    </div>
                    <div class="coins-header">
                        Pingcoins: <span id="coinsAmount">99999</span>
                    </div>
                </div>
                
                <div class="shop-tabs">
                    <div class="shop-tab active" onclick="showShopTab('cases')">Кейсы</div>
                    <div class="shop-tab" onclick="showShopTab('inventory')" id="inventoryTab">Инвентарь</div>
                </div>
                
                <div class="cases-section"><div class="cases-grid"></div></div>
                <div class="inventory-section hidden"><div class="inventory-grid"></div></div>

                <div class="bottom-nav">
                    <div class="nav-item" onclick="showMainScreen()"><span class="nav-icon">...</span><span class="nav-label">Главная</span></div>
                    <div class="nav-item active" onclick="showShopScreen()"><span class="nav-icon">...</span><span class="nav-label">Магазин</span></div>
                    <div class="nav-item" onclick="showProfileScreen()"><span class="nav-icon">...</span><span class="nav-label">Профиль</span></div>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profileScreen" class="screen screen-profile" style="display: none;">
                <!-- ... содержимое profileScreen ... (сокращено для экономии места, но в твоем коде оно есть) -->
                <div class="bottom-nav">
                    <div class="nav-item" onclick="showMainScreen()"><span class="nav-icon">...</span><span class="nav-label">Главная</span></div>
                    <div class="nav-item" onclick="showShopScreen()"><span class="nav-icon">...</span><span class="nav-label">Магазин</span></div>
                    <div class="nav-item active" onclick="showProfileScreen()"><span class="nav-icon">...</span><span class="nav-label">Профиль</span></div>
                </div>
            </div>

            <!-- Settings Screen -->
            <div id="settingsScreen" class="screen screen-settings" style="display: none;">
                <div class="section-title">Настройки</div>
                <div class="bottom-nav">
                    <div class="nav-item" onclick="showMainScreen()"><span class="nav-icon">...</span><span class="nav-label">Главная</span></div>
                    <div class="nav-item" onclick="showShopScreen()"><span class="nav-icon">...</span><span class="nav-label">Магазин</span></div>
                    <div class="nav-item" onclick="showProfileScreen()"><span class="nav-icon">...</span><span class="nav-label">Профиль</span></div>
                </div>
            </div>

            <!-- FACEIT Screen -->
            <div id="faceitScreen" class="screen screen-faceit" style="display: none;">
                <div class="mode-header">
                    <button class="back-btn" onclick="showMainScreen()">←</button>
                    <div class="mode-title faceit">FACEIT</div>
                </div>
                <!-- ... остальное содержимое faceitScreen ... -->
            </div>

            <!-- Premier Screen -->
            <div id="premierScreen" class="screen screen-premier" style="display: none;">
                <div class="mode-header">
                    <button class="back-btn" onclick="showMainScreen()">←</button>
                    <div class="mode-title premier">PREMIER</div>
                </div>
                <!-- ... остальное содержимое premierScreen ... -->
            </div>

            <!-- Prime Screen -->
            <div id="primeScreen" class="screen screen-prime" style="display: none;">
                <div class="mode-header">
                    <button class="back-btn" onclick="showMainScreen()">←</button>
                    <div class="mode-title prime">MM PRIME</div>
                </div>
                <!-- ... остальное содержимое primeScreen ... -->
            </div>

            <!-- Public Screen -->
            <div id="publicScreen" class="screen screen-public" style="display: none;">
                <div class="mode-header">
                    <button class="back-btn" onclick="showMainScreen()">←</button>
                    <div class="mode-title public">MM PUBLIC</div>
                </div>
                <!-- ... остальное содержимое publicScreen ... -->
            </div>

            <!-- Search Screen -->
            <div id="searchScreen" class="screen screen-search" style="display: none;">
                <div class="search-header">
                    <div class="search-title" id="searchModeTitle">FACEIT</div>
                    <div class="search-timer" id="searchTimer">00:00</div>
                </div>
                <div class="search-status" id="searchStatus">Поиск тиммейта начат</div>
                <div class="search-loading"><div class="spinner"></div></div>
                <button class="cancel-search-btn" onclick="cancelSearch()">Отменить поиск</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // TELEGRAM MINI APP INIT
        // ============================================
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        // Получаем данные пользователя
        const tgUser = tg.initDataUnsafe?.user;
        const TELEGRAM_ID = tgUser?.id || new URLSearchParams(window.location.search).get('tg_id');
        const USERNAME = tgUser?.username || tgUser?.first_name || 'player';
        
        console.log('Telegram ID:', TELEGRAM_ID);
        console.log('Username:', USERNAME);
        
        // API URL (используем HTTPS)
        const API_URL = 'https://matk91589-dev-pingster-backend-e306.twc1.net/api';
        
        // Глобальные переменные
        let currentUser = null;
        let searchTimer = null;
        let searchInterval = null;
        
        // ============================================
        // НАВИГАЦИЯ
        // ============================================
        function hideAllScreens() {
            const screens = [
                'startScreen', 'mainScreen', 'profileScreen', 'shopScreen', 'settingsScreen',
                'faceitScreen', 'premierScreen', 'primeScreen', 'publicScreen', 'searchScreen'
            ];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
        }
        
        function showMainScreen() {
            hideAllScreens();
            document.getElementById('mainScreen').style.display = 'flex';
        }
        
        function showProfileScreen() {
            hideAllScreens();
            document.getElementById('profileScreen').style.display = 'flex';
            loadProfile();
        }
        
        function showShopScreen() {
            hideAllScreens();
            document.getElementById('shopScreen').style.display = 'flex';
        }
        
        function showSettingsScreen() {
            hideAllScreens();
            document.getElementById('settingsScreen').style.display = 'flex';
        }
        
        function showFaceitScreen() {
            hideAllScreens();
            document.getElementById('faceitScreen').style.display = 'flex';
        }
        
        function showPremierScreen() {
            hideAllScreens();
            document.getElementById('premierScreen').style.display = 'flex';
        }
        
        function showPrimeScreen() {
            hideAllScreens();
            document.getElementById('primeScreen').style.display = 'flex';
        }
        
        function showPublicScreen() {
            hideAllScreens();
            document.getElementById('publicScreen').style.display = 'flex';
        }
        
        // ============================================
        // ЗАГРУЗКА ПРОФИЛЯ
        // ============================================
        function loadProfile() {
            if (currentUser) {
                document.getElementById('profileName').textContent = currentUser.username || '-';
                document.getElementById('ratingValue').value = currentUser.rating || 0;
            }
        }
        
        // ============================================
        // ИНИЦИАЛИЗАЦИЯ
        // ============================================
        async function initApp() {
            if (!TELEGRAM_ID) {
                console.error('Нет Telegram ID');
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/user/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: TELEGRAM_ID,
                        username: USERNAME
                    })
                });
                
                const data = await response.json();
                console.log('Init response:', data);
                
                if (data.status === 'ok') {
                    currentUser = {
                        id: data.user_id,
                        player_id: data.player_id,
                        telegram_id: TELEGRAM_ID,
                        username: USERNAME,
                        rating: 0
                    };
                    
                    // Показываем стартовый экран
                    document.getElementById('startScreen').style.display = 'flex';
                }
            } catch (error) {
                console.error('Init error:', error);
                tg.showAlert('Ошибка подключения к серверу');
            }
        }
        
        // ============================================
        // СТАРТ ПРИЛОЖЕНИЯ
        // ============================================
        function startApp() {
            hideAllScreens();
            document.getElementById('mainScreen').style.display = 'flex';
        }
        
        // ============================================
        // ФУНКЦИИ ПОИСКА (сокращено для примера)
        // ============================================
        async function startSearch(mode) {
            tg.showAlert(`Поиск в режиме ${mode} (в разработке)`);
        }
        
        function cancelSearch() {
            showMainScreen();
        }
        
        // ============================================
        // ЗАПУСК
        // ============================================
        document.addEventListener('DOMContentLoaded', initApp);
        
        // ============================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // ============================================
        function handleLogoClick() { showMainScreen(); }
        function setStyle(style, element) {
            document.querySelectorAll('.style-option').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
        function showShopTab(tab) { console.log('Show tab:', tab); }
        function enterSearchMode() { showFaceitScreen(); }
        function toggleEditMode() {}
        function applyChanges() {}
        function selectAvatar() {}
        function editName() {}
        function editAge() {}
        function editSteam() {}
        function editFaceitLink() {}
    </script>

    <!-- JavaScript файлы -->
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/globals.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/profile.js"></script>
    <script src="js/avatar.js"></script>
    <script src="js/shop.js"></script>
    <script src="js/friends.js"></script>
    <script src="js/search.js"></script>
    <script src="js/logo.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
